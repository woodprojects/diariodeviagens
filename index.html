<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minhas Viagens 2026 - v25.3</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        body {
            background-color: #0f172a;
            color: #cbd5e1;
            font-family: 'Inter', sans-serif;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        .card-premium {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 1.5rem;
            overflow: hidden;
        }

        .input-dark {
            background: #0f172a;
            border: 1px solid #334155;
            color: white;
            border-radius: 1rem;
            padding: 1rem;
            width: 100%;
            outline: none;
        }

        .status-badge {
            font-size: 10px;
            font-weight: 700;
            padding: 2px 10px;
            border-radius: 6px;
            text-transform: uppercase;
        }

        .badge-active {
            background: #1e3a8a;
            color: #fbbf24;
        }

        #toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 12px;
            color: white;
            z-index: 10000;
            display: none;
        }
    </style>
</head>

<body class="pb-24">

    <div id="toast"></div>

    <div id="main-app">
        <header class="p-5 border-b border-slate-800 sticky top-0 bg-slate-900/95 backdrop-blur z-40">
            <div class="max-w-md mx-auto flex justify-between items-center">
                <div>
                    <h2 class="text-sm font-bold text-white">Minhas Viagens 2026</h2>
                    <p id="user-display" class="text-[9px] text-blue-400 font-bold uppercase tracking-widest">
                        Carregando...</p>
                </div>
                <button onclick="handleLogout()" class="p-2 text-slate-500"><i data-lucide="log-out"
                        class="w-5 h-5"></i></button>
            </div>
        </header>

        <main class="max-w-md mx-auto p-5 relative">
            <div id="trips-view" class="view active space-y-5">
                <div id="list-container" class="space-y-5"></div>
            </div>

            <div id="details-view" class="view space-y-6">
                <div class="flex justify-between items-center mb-4">
                    <button onclick="closeTrip()"
                        class="text-xs text-blue-400 font-bold uppercase flex items-center gap-2"><i
                            data-lucide="arrow-left" class="w-4 h-4"></i> Voltar</button>
                    <button id="export-btn"
                        class="bg-slate-800 px-4 py-2 rounded-xl text-[10px] font-bold uppercase flex items-center gap-2"><i
                            data-lucide="download" class="w-3 h-3"></i> Exportar</button>
                </div>
                <div id="timeline-container" class="space-y-6 relative ml-2">
                    <div class="absolute left-[19px] top-2 bottom-2 w-0.5 bg-slate-800"></div>
                </div>
            </div>

            <button id="btn-floating-add" onclick="openCreateModal()"
                class="fixed bottom-8 right-8 bg-blue-600 text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center z-50">
                <i data-lucide="plus" class="w-8 h-8"></i>
            </button>
        </main>
    </div>

    <div id="modal-trip" class="fixed inset-0 bg-black/90 hidden z-[100] flex items-center justify-center p-6">
        <div class="bg-slate-900 border border-slate-800 w-full max-w-sm rounded-[2rem] p-6 space-y-4">
            <h3 id="m-title" class="text-white font-bold uppercase text-xs tracking-widest">Nova Viagem</h3>
            <input type="hidden" id="m-id">
            <input id="m-name" class="input-dark" placeholder="Nome da Viagem">
            <input id="m-origin" class="input-dark" placeholder="Origem">
            <div class="grid grid-cols-2 gap-2">
                <input id="m-lat" class="input-dark text-xs" placeholder="Lat Origem">
                <input id="m-lng" class="input-dark text-xs" placeholder="Lng Origem">
            </div>
            <input id="m-start" type="datetime-local" class="input-dark">
            <div class="grid grid-cols-2 gap-2">
                <input id="m-km-ini" type="number" class="input-dark" placeholder="KM Inicial">
                <input id="m-km-fin" type="number" class="input-dark" placeholder="KM Final (Auto)">
            </div>
            <div class="flex gap-2 pt-2">
                <button onclick="saveTripData()"
                    class="flex-1 bg-blue-600 p-3 rounded-xl font-bold text-xs uppercase">Salvar</button>
                <button onclick="closeModal()"
                    class="flex-1 bg-slate-800 p-3 rounded-xl font-bold text-xs uppercase text-slate-400">Sair</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://jjmnsijgzxknpwwzazwa.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqbW5zaWpnenhrbnB3d3phendhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1NTk3ODIsImV4cCI6MjA4NDEzNTc4Mn0.lOYFP23r7BGH0W0yzLCprSdldB6BijuLVi4UhnbTDRE";
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        function showToast(msg, err = false) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.background = err ? "#ef4444" : "#10b981";
            t.style.display = "block"; setTimeout(() => t.style.display = "none", 3000);
        }

        async function loadTrips() {
            const { data: trips } = await db.from('trips').select('*, trip_events(*)').order('start_datetime', { ascending: false });
            const container = document.getElementById('list-container');

            container.innerHTML = (trips || []).map(t => {
                const destinations = t.trip_events.filter(e => e.type === 'destino' || e.type === 'stops');
                const lastDest = destinations[destinations.length - 1]?.name_location || 'A definir';

                // Cálculo do maior KM anotado nos eventos para o KM Final
                const kms = t.trip_events.map(e => parseFloat(e.km_entry) || 0);
                const maxKm = kms.length > 0 ? Math.max(...kms) : (t.final_km || 0);

                return `
                    <div class="card-premium p-6 space-y-4">
                        <div class="flex justify-between items-start" onclick="openTripDetails('${t.id}')">
                            <div>
                                <h3 class="text-xl font-bold text-white">${t.name}</h3>
                                <p class="text-[9px] text-blue-400 font-bold uppercase">${new Date(t.start_datetime).toLocaleDateString()}</p>
                            </div>
                            <span class="status-badge ${t.is_active ? 'badge-active' : 'bg-emerald-900 text-emerald-400'}">${t.is_active ? 'Ativa' : 'Fim'}</span>
                        </div>
                        <div class="text-xs">
                            <p class="text-slate-400">Origem: <span class="text-white font-bold">${t.origin || 'Casa'}</span></p>
                            <p class="text-slate-400">Último: <span class="text-white font-bold">${lastDest}</span></p>
                            <p class="text-[10px] text-blue-500 mt-2">Distância: ${maxKm - (t.initial_km || 0)} KM rodados</p>
                        </div>
                        <div class="flex gap-4 pt-2 border-t border-slate-800">
                            <button onclick="prepareEdit('${t.id}')" class="text-slate-500"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                            <button onclick="confirmDelete('${t.id}')" class="text-slate-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        // --- FUNÇÕES DE MODAL ---
        function openCreateModal() {
            document.getElementById('m-title').innerText = "Nova Viagem";
            document.getElementById('m-id').value = "";
            document.getElementById('m-start').value = new Date().toISOString().slice(0, 16);
            document.getElementById('modal-trip').classList.remove('hidden');
        }

        async function prepareEdit(id) {
            const { data: t } = await db.from('trips').select('*, trip_events(km_entry)').eq('id', id).single();
            const kms = t.trip_events.map(e => parseFloat(e.km_entry) || 0);
            const maxKmValue = kms.length > 0 ? Math.max(...kms) : (t.final_km || 0);

            document.getElementById('m-title').innerText = "Editar Viagem";
            document.getElementById('m-id').value = t.id;
            document.getElementById('m-name').value = t.name;
            document.getElementById('m-origin').value = t.origin;
            document.getElementById('m-lat').value = t.origin_latitude || '';
            document.getElementById('m-lng').value = t.origin_longitude || '';
            document.getElementById('m-start').value = new Date(t.start_datetime).toISOString().slice(0, 16);
            document.getElementById('m-km-ini').value = t.initial_km;
            document.getElementById('m-km-fin').value = maxKmValue;
            document.getElementById('modal-trip').classList.remove('hidden');
        }

        async function saveTripData() {
            const id = document.getElementById('m-id').value;
            const payload = {
                name: document.getElementById('m-name').value,
                origin: document.getElementById('m-origin').value,
                origin_latitude: document.getElementById('m-lat').value,
                origin_longitude: document.getElementById('m-lng').value,
                start_datetime: document.getElementById('m-start').value,
                initial_km: parseFloat(document.getElementById('m-km-ini').value) || 0,
                final_km: parseFloat(document.getElementById('m-km-fin').value) || 0
            };

            if (id) await db.from('trips').update(payload).eq('id', id);
            else {
                const { data: { user } } = await db.auth.getUser();
                payload.user_id = user.id;
                await db.from('trips').insert([payload]);
            }
            closeModal(); loadTrips(); showToast("Dados salvos!");
        }

        // --- DETALHES E UI ---
        async function openTripDetails(id) {
            document.getElementById('trips-view').classList.remove('active');
            document.getElementById('details-view').classList.add('active');
            document.getElementById('btn-floating-add').classList.add('hidden'); // Ocultar botão

            const { data: evs } = await db.from('trip_events').select('*').eq('trip_id', id).order('datetime', { ascending: true });
            document.getElementById('timeline-container').innerHTML = evs.map(ev => `
                <div class="flex gap-4 relative z-10">
                    <div class="w-10 h-10 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center text-slate-500">
                        <i data-lucide="${ev.type === 'destino' ? 'map-pin' : 'circle'}" class="w-4 h-4"></i>
                    </div>
                    <div class="flex-1 card-premium p-4">
                        <h4 class="text-sm font-medium text-white">${ev.name_location}</h4>
                        <p class="text-[9px] text-slate-500 uppercase">${new Date(ev.datetime).toLocaleTimeString()}</p>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function closeTrip() {
            document.getElementById('details-view').classList.remove('active');
            document.getElementById('trips-view').classList.add('active');
            document.getElementById('btn-floating-add').classList.remove('hidden'); // Mostrar botão
        }

        function closeModal() { document.getElementById('modal-trip').classList.add('hidden'); }
        async function handleLogout() { await db.auth.signOut(); location.reload(); }

        window.onload = async () => {
            const { data: { session } } = await db.auth.getSession();
            if (session) {
                document.getElementById('user-display').innerText = `Logado: ${session.user.email}`;
                loadTrips();
            }
        };
    </script>
</body>

</html>