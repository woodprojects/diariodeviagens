<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minhas Viagens 2026 - v25.5</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        body {
            background-color: #0f172a;
            color: #cbd5e1;
            font-family: 'Inter', sans-serif;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        .card-premium {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 1.5rem;
            overflow: hidden;
        }

        .input-dark {
            background: #0f172a;
            border: 1px solid #334155;
            color: white;
            border-radius: 1rem;
            padding: 1rem;
            width: 100%;
            outline: none;
        }

        .status-badge {
            font-size: 10px;
            font-weight: 700;
            padding: 2px 10px;
            border-radius: 6px;
            text-transform: uppercase;
        }

        .badge-active {
            background: #1e3a8a;
            color: #fbbf24;
        }

        .mini-map-fallback {
            width: 100%;
            height: 120px;
            background: #0f172a;
            border-radius: 1rem;
            margin-top: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #334155;
        }

        #toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 12px;
            color: white;
            z-index: 10000;
            display: none;
        }
    </style>
</head>

<body class="pb-24">

    <div id="toast"></div>

    <div id="main-app" class="hidden">
        <header class="p-5 border-b border-slate-800 sticky top-0 bg-slate-900/95 backdrop-blur z-40">
            <div class="max-w-md mx-auto flex justify-between items-center">
                <div>
                    <h2 class="text-sm font-bold text-white">Minhas Viagens 2026</h2>
                    <p id="user-display" class="text-[9px] text-blue-400 font-bold uppercase tracking-widest">
                        Aguardando...</p>
                </div>
                <button onclick="handleLogout()" class="p-2 text-slate-500"><i data-lucide="log-out"
                        class="w-5 h-5"></i></button>
            </div>
        </header>

        <main class="max-w-md mx-auto p-5 relative">
            <div id="trips-view" class="view active space-y-5">
                <div id="list-container" class="space-y-5"></div>
            </div>

            <div id="details-view" class="view space-y-6">
                <button onclick="closeTrip()"
                    class="text-xs text-blue-400 font-bold uppercase flex items-center gap-2"><i
                        data-lucide="arrow-left" class="w-4 h-4"></i> Voltar</button>
                <div id="timeline-container" class="space-y-6 relative ml-2">
                    <div class="absolute left-[19px] top-2 bottom-2 w-0.5 bg-slate-800"></div>
                </div>
            </div>

            <button id="btn-floating-add" onclick="openCreateModal()"
                class="fixed bottom-8 right-8 bg-blue-600 text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center z-50">
                <i data-lucide="plus" class="w-8 h-8"></i>
            </button>
        </main>
    </div>

    <div id="modal-trip" class="fixed inset-0 bg-black/90 hidden z-[100] flex items-center justify-center p-6">
        <div class="bg-slate-900 border border-slate-700 w-full max-w-sm rounded-[2rem] p-8 space-y-4">
            <h3 id="m-title" class="text-white font-bold uppercase text-xs tracking-widest">Nova Viagem</h3>
            <input type="hidden" id="m-id">
            <input id="m-name" class="input-dark" placeholder="Nome da Viagem">
            <div class="flex gap-2">
                <input id="m-origin" class="input-dark" placeholder="Origem">
                <button onclick="getCurrentLocation()" class="bg-slate-800 p-3 rounded-xl text-blue-400"><i
                        data-lucide="navigation" class="w-5 h-5"></i></button>
            </div>
            <div class="grid grid-cols-2 gap-2 text-[10px]">
                <input id="m-lat" class="input-dark" placeholder="Latitude Origem" step="any">
                <input id="m-lng" class="input-dark" placeholder="Longitude Origem" step="any">
            </div>
            <input id="m-start" type="datetime-local" class="input-dark">
            <div class="grid grid-cols-2 gap-2">
                <input id="m-km-ini" type="number" class="input-dark" placeholder="KM Inicial">
                <input id="m-km-fin" type="number" class="input-dark" placeholder="KM Final">
            </div>
            <div class="flex gap-2 pt-4">
                <button onclick="saveTripData()"
                    class="flex-1 bg-blue-600 p-4 rounded-2xl font-bold text-xs uppercase">Salvar</button>
                <button onclick="closeModal()"
                    class="flex-1 bg-slate-800 p-4 rounded-2xl font-bold text-xs uppercase text-slate-400">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://jjmnsijgzxknpwwzazwa.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqbW5zaWpnenhrbnB3d3phendhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1NTk3ODIsImV4cCI6MjA4NDEzNTc4Mn0.lOYFP23r7BGH0W0yzLCprSdldB6BijuLVi4UhnbTDRE";
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function loadTrips() {
            const { data: trips } = await db.from('trips').select('*, trip_events(*)').order('start_datetime', { ascending: false });
            const container = document.getElementById('list-container');

            container.innerHTML = (trips || []).map(t => {
                const destinations = t.trip_events.filter(e => e.type === 'destino' || e.type === 'stops');
                const last = destinations[destinations.length - 1] || { name_location: 'Destino', latitude: null, longitude: null };

                // Correção do Mapa: Uso de OpenStreetMap (Sem chave de API necessária)
                const hasCoords = t.origin_latitude && last.latitude;
                const mapHtml = hasCoords ?
                    `<div class="mini-map-fallback text-blue-400 text-[10px] uppercase font-bold flex flex-col gap-2" onclick="openTripDetails('${t.id}')">
                        <i data-lucide="map" class="w-6 h-6"></i> Mapa Disponível (Clique para ver)
                    </div>` : '';

                return `
                    <div class="card-premium p-6 space-y-4">
                        <div class="flex justify-between items-start" onclick="openTripDetails('${t.id}')">
                            <div>
                                <h3 class="text-xl font-bold text-white">${t.name}</h3>
                                <p class="text-[9px] text-blue-400 font-bold uppercase">${new Date(t.start_datetime).toLocaleDateString()}</p>
                            </div>
                            <span class="status-badge ${t.is_active ? 'badge-active' : 'bg-emerald-900 text-emerald-400'}">${t.is_active ? 'Em andamento' : 'Encerrada'}</span>
                        </div>
                        <div class="text-xs space-y-2">
                            <div class="flex justify-between">
                                <span class="text-slate-500 uppercase text-[8px] font-bold">Origem</span>
                                <span class="text-white font-bold">${t.origin || 'Não definida'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-500 uppercase text-[8px] font-bold">Último Destino</span>
                                <span class="text-white font-bold">${last.name_location}</span>
                            </div>
                            <p class="text-[10px] text-blue-500 font-bold mt-2">Distância: ${(t.final_km || 0) - (t.initial_km || 0)} KM rodados</p>
                        </div>
                        ${mapHtml}
                        <div class="flex gap-4 pt-4 border-t border-slate-800">
                            <button onclick="prepareEdit('${t.id}')" class="text-slate-500"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                            <button onclick="confirmDelete('${t.id}')" class="text-slate-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        // --- CORREÇÃO DO LOOP NO DESKTOP ---
        async function checkSession() {
            const { data: { session } } = await db.auth.getSession();
            if (session) {
                document.getElementById('user-display').innerText = `Logado: ${session.user.email}`;
                loadTrips();
            } else {
                // Em vez de redirecionar para index.html (que causa loop), apenas mantém a view de login oculta se estiver no app.js
                console.log("Sessão não encontrada");
            }
        }

        function openCreateModal() {
            document.getElementById('m-title').innerText = "Nova Viagem";
            document.getElementById('m-id').value = "";
            document.getElementById('m-name').value = "";
            document.getElementById('m-origin').value = "";
            document.getElementById('m-lat').value = "";
            document.getElementById('m-lng').value = "";
            document.getElementById('m-km-ini').value = "";
            document.getElementById('m-km-fin').value = "";
            document.getElementById('m-start').value = new Date().toLocaleString('sv-SE').slice(0, 16); // Formato correto para input datetime-local
            document.getElementById('modal-trip').classList.remove('hidden');
        }

        function getCurrentLocation() {
            if (!navigator.geolocation) return alert("GPS não disponível");
            navigator.geolocation.getCurrentPosition(p => {
                document.getElementById('m-lat').value = p.coords.latitude.toFixed(6);
                document.getElementById('m-lng').value = p.coords.longitude.toFixed(6);
                alert("Coordenadas da Origem capturadas!");
            }, (err) => alert("Erro ao capturar GPS: " + err.message));
        }

        async function saveTripData() {
            const id = document.getElementById('m-id').value;
            const payload = {
                name: document.getElementById('m-name').value,
                origin: document.getElementById('m-origin').value,
                origin_latitude: document.getElementById('m-lat').value ? parseFloat(document.getElementById('m-lat').value) : null,
                origin_longitude: document.getElementById('m-lng').value ? parseFloat(document.getElementById('m-lng').value) : null,
                start_datetime: document.getElementById('m-start').value,
                initial_km: parseFloat(document.getElementById('m-km-ini').value) || 0,
                final_km: parseFloat(document.getElementById('m-km-fin').value) || 0
            };

            const { data: { user } } = await db.auth.getUser();
            if (id) await db.from('trips').update(payload).eq('id', id);
            else {
                payload.user_id = user.id;
                payload.is_active = true;
                await db.from('trips').insert([payload]);
            }
            closeModal(); loadTrips();
        }

        // --- CORREÇÃO DA IMPORTAÇÃO: MAPEAMENTO DE CAMPOS ---
        window.importJSON = async function (event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const trip = JSON.parse(e.target.result);
                    const { data: { user } } = await db.auth.getUser();

                    // Mapeia campos do JSON para o banco (originLatitude -> origin_latitude)
                    const { data: newTrip } = await db.from('trips').insert([{
                        user_id: user.id,
                        name: trip.name,
                        start_datetime: trip.startDatetime,
                        origin: trip.origin,
                        origin_latitude: parseFloat(trip.originLatitude),
                        origin_longitude: parseFloat(trip.originLongitude),
                        initial_km: parseFloat(trip.initialKm) || 0,
                        is_active: true
                    }]).select().single();

                    const batch = [];
                    if (trip.stops) trip.stops.forEach(s => batch.push({
                        trip_id: newTrip.id, type: 'destino', datetime: s.datetimeChegada,
                        name_location: s.name, km_entry: parseFloat(s.kmChegada),
                        latitude: parseFloat(s.latitude), longitude: parseFloat(s.longitude)
                    }));

                    await db.from('trip_events').insert(batch);
                    loadTrips();
                } catch (err) { alert("Erro ao ler JSON"); }
            };
            reader.readAsText(file);
        };

        async function openTripDetails(id) {
            document.getElementById('trips-view').classList.remove('active');
            document.getElementById('details-view').classList.add('active');
            document.getElementById('btn-floating-add').classList.add('hidden');
            const { data: evs } = await db.from('trip_events').select('*').eq('trip_id', id).order('datetime', { ascending: true });
            document.getElementById('timeline-container').innerHTML = evs.map(ev => `
                <div class="flex gap-4 relative z-10">
                    <div class="w-10 h-10 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center text-slate-500">
                        <i data-lucide="${ev.type === 'abastecimento' ? 'fuel' : 'map-pin'}" class="w-4 h-4"></i>
                    </div>
                    <div class="flex-1 card-premium p-4">
                        <h4 class="text-sm font-medium text-white">${ev.name_location}</h4>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-[9px] uppercase text-slate-500">${new Date(ev.datetime).toLocaleTimeString()}</span>
                            ${ev.latitude ? `<button onclick="window.open('https://waze.com/ul?ll=${ev.latitude},${ev.longitude}&navigate=yes')" class="text-emerald-400 font-bold text-[9px]">NAVEGAR</button>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function closeModal() { document.getElementById('modal-trip').classList.add('hidden'); }
        function closeTrip() { document.getElementById('details-view').classList.remove('active'); document.getElementById('trips-view').classList.add('active'); document.getElementById('btn-floating-add').classList.remove('hidden'); }
        async function handleLogout() { await db.auth.signOut(); window.location.reload(); }

        window.onload = checkSession;
    </script>
</body>

</html>