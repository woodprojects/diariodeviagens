<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minhas Viagens 2026 - v25.2</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        body {
            background-color: #0f172a;
            color: #cbd5e1;
            font-family: 'Inter', sans-serif;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        .card-premium {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 1.5rem;
            overflow: hidden;
        }

        .input-dark {
            background: #0f172a;
            border: 1px solid #334155;
            color: white;
            border-radius: 1rem;
            padding: 1rem;
            width: 100%;
            outline: none;
        }

        .status-badge {
            font-size: 10px;
            font-weight: 700;
            padding: 2px 10px;
            border-radius: 6px;
            text-transform: uppercase;
        }

        .badge-active {
            background: #1e3a8a;
            color: #fbbf24;
        }

        .mini-map-static {
            width: 100%;
            height: 100px;
            background: #0f172a;
            border-radius: 1rem;
            margin-top: 12px;
        }

        #toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 12px;
            color: white;
            z-index: 10000;
            display: none;
        }
    </style>
</head>

<body class="pb-24">

    <div id="toast"></div>

    <div id="main-app" class="hidden">
        <header class="p-5 border-b border-slate-800 sticky top-0 bg-slate-900/95 backdrop-blur z-40">
            <div class="max-w-md mx-auto flex justify-between items-center">
                <div>
                    <h2 class="text-sm font-bold text-white">Minhas Viagens 2026</h2>
                    <p id="user-display" class="text-[9px] text-blue-400 font-bold uppercase tracking-widest">---</p>
                </div>
                <button onclick="handleLogout()" class="p-2 text-slate-500 hover:text-red-400"><i data-lucide="log-out"
                        class="w-5 h-5"></i></button>
            </div>
        </header>

        <main class="max-w-md mx-auto p-5 relative">
            <div id="trips-view" class="view active space-y-5">
                <div id="list-container" class="space-y-5"></div>
                <div class="py-8 text-center border-2 border-dashed border-slate-800 rounded-3xl">
                    <button onclick="document.getElementById('import-file').click()"
                        class="text-[10px] font-bold text-blue-400 uppercase flex items-center gap-2 mx-auto"><i
                            data-lucide="upload-cloud"></i> Sincronizar Backup</button>
                    <input type="file" id="import-file" class="hidden" accept=".json"
                        onchange="window.importJSON(event)">
                </div>
            </div>

            <div id="details-view" class="view space-y-6">
                <div class="flex justify-between items-center mb-4">
                    <button onclick="closeTrip()"
                        class="text-xs text-blue-400 font-bold uppercase flex items-center gap-2"><i
                            data-lucide="arrow-left" class="w-4 h-4"></i> Voltar</button>
                    <button id="export-btn"
                        class="bg-slate-800 px-4 py-2 rounded-xl text-[10px] font-bold uppercase flex items-center gap-2"><i
                            data-lucide="download" class="w-3 h-3"></i> Exportar JSON</button>
                </div>
                <div id="timeline-container" class="space-y-6 relative ml-2">
                    <div class="absolute left-[19px] top-2 bottom-2 w-0.5 bg-slate-800"></div>
                </div>
            </div>

            <button id="float-add-btn" onclick="openCreateModal()"
                class="fixed bottom-8 right-8 bg-blue-600 text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center z-50 transition-all">
                <i data-lucide="plus" class="w-8 h-8"></i>
            </button>
        </main>
    </div>

    <div id="trip-modal" class="fixed inset-0 bg-black/90 hidden z-[100] flex items-center justify-center p-6">
        <div class="bg-slate-900 border border-slate-800 w-full max-w-sm rounded-[2.5rem] p-8 space-y-4 shadow-2xl">
            <h3 id="modal-title" class="text-white font-bold uppercase text-sm tracking-widest">Nova Viagem</h3>
            <input id="t-id" type="hidden">
            <input id="t-name" class="input-dark" placeholder="Nome da Viagem">
            <input id="t-origin" class="input-dark" placeholder="Origem (Ex: Casa)">
            <input id="t-start" type="datetime-local" class="input-dark">
            <div class="grid grid-cols-2 gap-2">
                <input id="t-km" type="number" class="input-dark" placeholder="KM Inicial">
                <select id="t-active" class="input-dark">
                    <option value="true">Em andamento</option>
                    <option value="false">Encerrada</option>
                </select>
            </div>
            <div class="flex gap-3 pt-4">
                <button onclick="saveTrip()"
                    class="flex-1 bg-blue-600 p-4 rounded-2xl font-bold text-xs uppercase">Confirmar</button>
                <button onclick="closeModal()"
                    class="flex-1 bg-slate-800 p-4 rounded-2xl font-bold text-xs uppercase text-slate-400">Sair</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://jjmnsijgzxknpwwzazwa.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqbW5zaWpnenhrbnB3d3phendhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1NTk3ODIsImV4cCI6MjA4NDEzNTc4Mn0.lOYFP23r7BGH0W0yzLCprSdldB6BijuLVi4UhnbTDRE";
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let currentTripId = null;

        function showToast(msg, error = false) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.backgroundColor = error ? "#ef4444" : "#10b981";
            t.style.display = "block"; setTimeout(() => t.style.display = "none", 3000);
        }

        // --- CARREGAMENTO E CARD COM MAPA ---
        async function loadTrips() {
            const { data: trips } = await db.from('trips').select('*, trip_events(*)').order('start_datetime', { ascending: false });
            const container = document.getElementById('list-container');

            container.innerHTML = (trips || []).map(t => {
                const destinations = t.trip_events.filter(ev => ev.type === 'destino' || ev.type === 'stops');
                const last = destinations[destinations.length - 1] || { name_location: 'Destino', latitude: null, longitude: null };

                // Mapa estático com pins de Origem e Último Destino
                const pins = t.origin_latitude ? `markers=color:blue|label:O|${t.origin_latitude},${t.origin_longitude}&` : '';
                const destPin = last.latitude ? `markers=color:red|label:D|${last.latitude},${last.longitude}` : '';
                const mapUrl = (t.origin_latitude || last.latitude) ? `https://maps.googleapis.com/maps/api/staticmap?size=400x120&scale=2&${pins}${destPin}&key=YOUR_API_KEY` : '';

                return `
                    <div class="card-premium p-6 space-y-4">
                        <div class="flex justify-between items-start" onclick="openTrip('${t.id}')">
                            <div>
                                <h3 class="text-xl font-bold text-blue-400">${t.name}</h3>
                                <p class="text-[9px] text-slate-500 font-bold">${new Date(t.start_datetime).toLocaleString('pt-BR')}</p>
                            </div>
                            <span class="status-badge ${t.is_active ? 'badge-active' : 'bg-emerald-900/40 text-emerald-400'}">${t.is_active ? 'Em andamento' : 'Encerrada'}</span>
                        </div>

                        <div class="flex items-center justify-between text-xs font-medium text-slate-400">
                            <div class="flex flex-col">
                                <span class="text-[8px] uppercase text-slate-600">Origem</span>
                                <button onclick="nav('${t.origin_latitude}', '${t.origin_longitude}')" class="text-white hover:text-blue-400 text-left">${t.origin || 'Casa'}</button>
                            </div>
                            <i data-lucide="arrow-right" class="w-3 h-3"></i>
                            <div class="flex flex-col text-right">
                                <span class="text-[8px] uppercase text-slate-600">Último Destino</span>
                                <button onclick="nav('${last.latitude}', '${last.longitude}')" class="text-white hover:text-blue-400 text-right">${last.name_location}</button>
                            </div>
                        </div>

                        ${mapUrl ? `<img src="${mapUrl}" class="mini-map-static object-cover" onclick="openTrip('${t.id}')">` : ''}

                        <div class="flex justify-between pt-4 border-t border-slate-800">
                            <div class="flex gap-6">
                                <button onclick="editTrip('${t.id}')" class="text-slate-500 hover:text-blue-400"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                                <button onclick="confirmDelete('${t.id}')" class="text-slate-600 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="nav('${last.latitude}', '${last.longitude}', 'waze')" class="p-2 bg-emerald-500/10 rounded-lg text-emerald-500"><i data-lucide="navigation-2" class="w-4 h-4"></i></button>
                                <button onclick="nav('${last.latitude}', '${last.longitude}', 'google')" class="p-2 bg-blue-500/10 rounded-lg text-blue-500"><i data-lucide="map" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        // --- NAVEGAÇÃO EXTERNA ---
        function nav(lat, lng, mode = 'google') {
            if (!lat || lat === 'null') return showToast("Coordenadas não cadastradas", true);
            const url = mode === 'waze' ? `https://waze.com/ul?ll=${lat},${lng}&navigate=yes` : `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
            window.open(url, '_blank');
        }

        // --- MODAL COM DATA DEFAULT ---
        function openCreateModal() {
            document.getElementById('modal-title').innerText = "Nova Viagem";
            document.getElementById('t-id').value = "";
            document.getElementById('t-start').value = new Date().toISOString().slice(0, 16); // Data/Hora atual como default
            document.getElementById('trip-modal').classList.remove('hidden');
        }

        async function editTrip(id) {
            const { data: t } = await db.from('trips').select('*').eq('id', id).single();
            document.getElementById('modal-title').innerText = "Editar Viagem";
            document.getElementById('t-id').value = t.id;
            document.getElementById('t-name').value = t.name;
            document.getElementById('t-origin').value = t.origin;
            document.getElementById('t-start').value = new Date(t.start_datetime).toISOString().slice(0, 16);
            document.getElementById('t-km').value = t.initial_km;
            document.getElementById('t-active').value = t.is_active.toString();
            document.getElementById('trip-modal').classList.remove('hidden');
        }

        async function saveTrip() {
            const id = document.getElementById('t-id').value;
            const payload = {
                name: document.getElementById('t-name').value,
                origin: document.getElementById('t-origin').value,
                start_datetime: document.getElementById('t-start').value,
                initial_km: parseFloat(document.getElementById('t-km').value),
                is_active: document.getElementById('t-active').value === 'true'
            };

            if (id) await db.from('trips').update(payload).eq('id', id);
            else {
                const { data: user } = await db.auth.getUser();
                payload.user_id = user.user.id;
                await db.from('trips').insert([payload]);
            }
            closeModal(); loadTrips();
        }

        // --- EXPORTAÇÃO JSON ---
        async function exportTripJSON() {
            const { data: trip } = await db.from('trips').select('*, trip_events(*)').eq('id', currentTripId).single();
            const blob = new Blob([JSON.stringify(trip, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `${trip.name}_backup.json`;
            a.click();
        }

        async function openTrip(id) {
            currentTripId = id;
            const { data: evs } = await db.from('trip_events').select('*').eq('trip_id', id).order('datetime', { ascending: true });
            document.getElementById('trips-view').classList.remove('active');
            document.getElementById('details-view').classList.add('active');
            document.getElementById('float-add-btn').classList.add('hidden'); // Oculta botão flutuante
            document.getElementById('export-btn').onclick = exportTripJSON;

            document.getElementById('timeline-container').innerHTML = evs.map(ev => `
                <div class="flex gap-4 relative z-10">
                    <div class="w-10 h-10 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center">
                        <i data-lucide="${ev.type === 'abastecimento' ? 'fuel' : 'map-pin'}" class="w-4 h-4 text-slate-400"></i>
                    </div>
                    <div class="flex-1 card-premium p-4">
                        <span class="text-[8px] text-slate-500 font-bold uppercase">${new Date(ev.datetime).toLocaleTimeString()}</span>
                        <h4 class="text-sm font-medium text-white">${ev.name_location}</h4>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function closeTrip() {
            document.getElementById('details-view').classList.remove('active');
            document.getElementById('trips-view').classList.add('active');
            document.getElementById('float-add-btn').classList.remove('hidden');
        }

        async function handleLogout() { await db.auth.signOut(); location.reload(); }
        function closeModal() { document.getElementById('trip-modal').classList.add('hidden'); }

        window.onload = async () => {
            const { data: { session } } = await db.auth.getSession();
            if (session) {
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('user-display').innerText = `Logado: ${session.user.email}`;
                loadTrips();
            } else location.href = 'index.html'; // Redireciona se não houver login
        };
    </script>
</body>

</html>